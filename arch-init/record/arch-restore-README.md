# Arch Linux 自动恢复脚本

这是一个用于Arch Linux系统的自动恢复脚本，配套`arch-backup.sh`使用，可以从备份中恢复系统配置、用户配置、自定义路径和软件包列表。

## 功能特点

- **选择性恢复**：允许用户选择恢复特定内容（系统配置、用户配置、自定义路径、软件包列表）
- **交互式恢复界面**：提供友好的命令行交互界面，引导用户完成恢复过程
- **完整性验证**：在恢复前检查备份的完整性，确保备份数据可用
- **冲突处理机制**：当恢复的文件与当前系统文件冲突时，提供多种处理选项
- **测试模式**：支持模拟恢复过程，不实际修改系统
- **强制恢复模式**：可以跳过确认步骤，直接执行恢复操作
- **非交互模式**：支持自动恢复，无需用户干预
- **压缩备份支持**：可以从压缩的备份文件中恢复数据
- **详细日志记录**：记录恢复过程中的所有操作和错误

## 安装和依赖

### 核心依赖

脚本运行需要以下核心依赖：

- `rsync`：远程同步工具
- `tar`：归档工具
- `find`：文件查找工具
- `grep`：文本搜索工具
- `awk`：文本处理工具
- `sed`：流编辑器
- `diff`：文件比较工具
- `cmp`：字节比较工具

### 压缩工具依赖

根据备份的压缩格式，可能需要以下压缩工具：

- `gzip`：gzip压缩工具
- `bzip2`：bzip2压缩工具
- `xz`：xz压缩工具

### 安装依赖

可以使用以下命令安装所有必要的依赖：

```bash
sudo pacman -S rsync tar findutils grep gawk sed diffutils gzip bzip2 xz
```

## 使用方法

### 基本用法

```bash
# 以交互模式运行恢复脚本
sudo ./arch-restore.sh

# 以非交互模式运行恢复脚本
sudo ./arch-restore.sh --non-interactive

# 以测试模式运行恢复脚本
sudo ./arch-restore.sh --dry-run

# 强制恢复模式
sudo ./arch-restore.sh --force
```

### 命令行选项

- `--help`：显示帮助信息
- `--version`：显示版本信息
- `--dry-run`：测试模式，不实际修改系统
- `--force`：强制恢复模式，跳过确认步骤
- `--non-interactive`：非交互模式，自动恢复所有内容
- `--backup-dir <目录>`：指定备份目录
- `--config <文件>`：指定配置文件
- `--log <文件>`：指定日志文件

## 恢复流程

1. **检查依赖**：脚本首先检查必要的依赖是否已安装
2. **加载配置**：从配置文件加载恢复设置
3. **列出可用备份**：显示所有可用的备份
4. **选择备份**：用户选择要恢复的备份
5. **解压备份**（如果是压缩备份）：将压缩的备份文件解压到临时目录
6. **检查备份完整性**：验证备份的完整性
7. **选择恢复内容**：用户选择要恢复的内容（系统配置、用户配置、自定义路径、软件包列表）
8. **确认恢复操作**：显示恢复摘要并请求用户确认
9. **执行恢复**：根据用户选择恢复相应内容
10. **清理临时文件**：删除恢复过程中创建的临时文件

## 恢复选项详解

### 系统配置恢复

恢复`/etc`目录下的系统配置文件。需要root权限。

- 在恢复前会备份当前系统配置到临时目录
- 使用rsync进行恢复，保留文件权限和所有权
- 可以处理文件冲突，提供多种冲突处理选项

### 用户配置恢复

恢复用户的配置文件，如`.bashrc`、`.zshrc`、`.config`目录等。

- 恢复前会备份当前用户配置到临时目录
- 可以处理文件冲突，提供查看差异、使用备份文件或保留当前文件等选项
- 支持批量处理冲突

### 自定义路径恢复

恢复自定义路径，如`/opt/myapp`、`/var/www`等。

- 可能需要root权限（取决于恢复路径）
- 支持恢复到不同的目标路径
- 处理路径冲突，提供覆盖、跳过或恢复到其他位置等选项

### 软件包列表恢复

恢复已安装的软件包列表，包括官方软件包和AUR软件包。

- 需要root权限
- 使用pacman恢复官方软件包
- 支持使用多种AUR助手（yay、paru、pamac等）恢复AUR软件包
- 可以选择性恢复官方软件包或AUR软件包

## 配置文件

脚本使用`~/.config/arch-backup.conf`作为配置文件，与`arch-backup.sh`共享配置。主要配置项包括：

```bash
# 备份根目录
BACKUP_ROOT="/mnt/backup/arch-backup"

# 要备份的用户配置文件和目录（空格分隔）
USER_CONFIG_FILES=".bashrc .zshrc .config/fish/config.fish .profile .bash_profile .zprofile .config .local/share .themes .icons .fonts .ssh .gnupg .mozilla .config/chromium .vimrc .config/nvim .tmux.conf .gitconfig .xinitrc .xprofile"

# 要排除的用户配置文件和目录（空格分隔）
EXCLUDE_USER_CONFIGS=".cache node_modules .npm .yarn .local/share/Trash"

# 要排除的系统配置目录（空格分隔）
EXCLUDE_SYSTEM_CONFIGS="/etc/pacman.d/gnupg"

# 自定义备份路径（空格分隔）
CUSTOM_PATHS="/opt/myapp /var/www /srv/data"

# 要排除的自定义路径（空格分隔）
EXCLUDE_CUSTOM_PATHS="*/temp */cache */logs"
```

## 常见问题解答

### Q: 恢复过程中遇到权限错误怎么办？

**A**: 恢复系统配置和软件包列表需要root权限，请使用`sudo`运行脚本。

### Q: 如何只恢复特定的用户配置文件？

**A**: 在交互模式下选择恢复用户配置，然后在恢复过程中跳过不需要的文件。

### Q: 备份文件损坏或不完整怎么办？

**A**: 脚本会在恢复前检查备份完整性，如果发现问题会提示用户。可以使用`--force`选项强制恢复可用部分。

### Q: 如何在不修改系统的情况下测试恢复过程？

**A**: 使用`--dry-run`选项运行脚本，这将模拟恢复过程但不实际修改系统。

### Q: 恢复AUR软件包时找不到AUR助手怎么办？

**A**: 脚本会检查常见的AUR助手（yay、paru、pamac），如果都不存在，会提示用户安装。可以先恢复官方软件包，然后安装AUR助手，再恢复AUR软件包。

## 注意事项

- 恢复系统配置和软件包列表需要root权限
- 恢复前建议备份重要数据
- 测试模式不会实际修改系统，但会创建临时文件
- 强制恢复模式会跳过确认步骤，请谨慎使用
- 恢复过程中的日志会保存在备份目录下

## 版本历史

- **1.0 版本**：基础恢复功能
  - 选择性恢复（允许用户选择恢复特定内容）
  - 交互式恢复界面
  - 完整性验证
  - 冲突处理机制