# 备份验证系统使用说明

## 概述

备份验证系统是一个全面的框架，用于验证备份的完整性、一致性和可恢复性。它整合了多种验证方法，提供详细的验证报告，帮助确保备份数据的可靠性。

## 验证类型

验证系统包含以下七种验证类型：

1. **基本存在性验证**：检查备份文件或目录是否存在，以及文件大小是否合理。
2. **文件完整性验证**：使用校验和工具验证文件内容是否完整，检查空文件和不可读文件。
3. **权限验证**：检查文件权限是否正确，包括可读性、可执行性和安全性。
4. **结构验证**：验证备份目录结构是否完整，关键目录和文件是否存在。
5. **统计信息验证**：验证目标目录加上源目录中被排除项的总量是否等于源目录的总量。
6. **排除项验证**：确保配置中指定的排除项确实未被备份。
7. **恢复点验证**（可选）：验证恢复点的有效性，确保可以从中断处继续备份。

## 配置选项

在`arch-backup.conf`中添加以下配置选项：

```bash
# 是否验证备份 (true/false)
VERIFY_BACKUP=true

# 是否验证恢复点 (true/false)
VERIFY_RECOVERY_POINT=true

# 验证报告保留天数
VERIFY_REPORT_RETENTION_DAYS=30
```

## 使用方法

### 基本用法

在备份脚本中调用验证系统：

```bash
# 加载验证系统模块
source "$SOURCE_DIR/modules/verify_system.sh"

# 执行备份操作...

# 执行完整验证
if verify_system; then
    log_notice "备份验证通过"
else
    log_error "备份验证失败"
    # 可以在这里添加失败处理逻辑
fi
```

### 单独验证

也可以单独调用特定的验证函数：

```bash
# 只验证文件完整性
if verify_file_integrity; then
    log_notice "文件完整性验证通过"
else
    log_error "文件完整性验证失败"
fi

# 只验证统计信息
if verify_statistics; then
    log_notice "统计信息验证通过"
else
    log_error "统计信息验证失败"
fi
```

## 验证报告

验证系统会生成详细的验证报告，保存在`${BACKUP_ROOT}/verify_reports/`目录下。报告包含以下内容：

- 每种验证类型的结果（通过/失败）
- 错误和警告的数量
- 验证耗时
- 总体验证状态

示例报告：

```
备份验证报告 - Wed Apr 3 10:15:23 CST 2024
===================================

1. 基本存在性验证
结果: 通过

2. 文件完整性验证
结果: 通过

3. 权限验证
结果: 通过

4. 结构验证
结果: 通过

5. 统计信息验证
结果: 通过

6. 排除项验证
结果: 通过

7. 恢复点验证
结果: 通过

===================================
验证总结:
- 总验证项: 7
- 错误数: 0
- 警告数: 2
- 验证耗时: 45秒
- 验证状态: 通过
===================================
```

## 日志输出

验证系统使用`utils/loggings.sh`模块记录详细的日志信息。日志级别可以在配置文件中设置：

```bash
LOG_LEVEL="INFO"  # 可选值: TRACE, DEBUG, INFO, NOTICE, WARN, ERROR, CRITICAL, FATAL
```

## 注意事项

1. 对于压缩备份，某些验证类型（如权限验证、结构验证等）将被跳过，因为这些验证需要直接访问文件系统。
2. 统计信息验证可能需要较长时间，特别是对于大型备份。
3. 恢复点验证需要在配置中启用`VERIFY_RECOVERY_POINT=true`。
4. 验证系统依赖于`utils/loggings.sh`模块，确保在使用前已加载此模块。

## 故障排除

如果验证失败，请检查以下几点：

1. 查看验证报告和日志文件，了解具体的失败原因。
2. 确保备份目录和文件具有正确的权限。
3. 检查排除项配置是否正确。
4. 对于统计信息验证失败，可能需要检查源目录和目标目录的文件数量和大小。

## 扩展

验证系统设计为模块化的，可以根据需要添加新的验证类型。要添加新的验证类型，请遵循以下步骤：

1. 在`verify_system.sh`中添加新的验证函数。
2. 在`verify_system()`函数中调用新的验证函数。
3. 更新验证报告格式以包含新的验证类型。