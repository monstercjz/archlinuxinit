# Arch Linux 恢复脚本 (arch-restore.sh) 说明文档

## 概述

`arch-restore.sh` 是一个用于从 `arch-backup.sh` (或其衍生版本如 `back_archlinux*.sh`) 创建的备份中恢复 Arch Linux 系统配置、用户配置、自定义路径和软件包列表的 Bash 脚本。它提供了灵活的恢复选项，旨在帮助用户在系统出现问题或迁移到新系统时恢复重要数据。

## 主要功能

1.  **读取备份配置**：自动尝试加载位于 `$HOME/.config/arch-backup.conf` 的备份配置文件，以获取备份根目录 (`BACKUP_ROOT`) 和其他相关设置（如自定义路径 `CUSTOM_PATHS`）。
2.  **备份源选择**：
    *   自动扫描备份根目录，查找可用的备份（按日期命名的目录或 `YYYY-MM-DD_backup.tar.*` 格式的压缩文件）。
    *   提供交互式菜单让用户选择要从中恢复的备份源。
    *   如果选择的是压缩备份文件，脚本会自动将其解压到临时目录进行恢复。
3.  **选择性恢复**：
    *   检查选定备份源中实际存在的组件（系统配置 `etc`、用户配置 `home`、自定义路径 `custom`、软件包列表 `packages`）。
    *   提供交互式菜单，允许用户选择恢复一个或多个特定组件，或选择“全部恢复”。
4.  **恢复前备份 (可选)**：
    *   如果在配置文件中启用了 `BACKUP_BEFORE_RESTORE=true`，脚本会在恢复前询问用户是否要备份将被覆盖的目标文件或目录。
    *   如果用户确认，脚本会尝试将目标路径移动或复制到一个带有 `_pre_restore_YYYYMMDDHHMMSS` 后缀的新位置，以防止意外覆盖。
    *   **注意**：对整个家目录 (`/home/user`) 执行此操作可能非常耗时且占用大量空间，脚本会对此发出警告。对于家目录恢复，推荐使用 `rsync` 内建的 `--backup` 选项（如果启用恢复前备份）。
5.  **恢复执行**：
    *   **系统配置 (`etc`)**：使用 `sudo rsync` 将备份中的 `/etc` 目录内容同步恢复到系统的 `/etc` 目录。使用 `--delete` 选项删除目标目录中备份源不存在的文件。
    *   **用户配置 (`home`)**：使用 `rsync` 将备份中的 `/home` 目录内容同步恢复到当前用户的家目录 (`$HOME`)。使用 `--delete` 选项。如果启用了恢复前备份，会优先尝试使用 `rsync` 的 `--backup` 选项。恢复后会尝试使用 `sudo chown` 确保文件所有权正确。
    *   **自定义路径 (`custom`)**：读取配置文件中的 `CUSTOM_PATHS` 变量，将备份中 `custom/` 目录下对应的子目录或文件使用 `sudo rsync` 恢复到原始路径。使用 `--delete` 选项。
    *   **软件包列表 (`packages`)**：读取备份中 `packages/manually-installed.txt` 文件，提取软件包名称，并使用 `sudo pacman -S --needed --noconfirm` 尝试安装列表中的软件包。`--needed` 选项可以避免重新安装已经是最新版本的软件包。
6.  **恢复后验证 (可选)**：
    *   在恢复操作成功后，询问用户是否执行验证。
    *   **文件验证**：对 `etc`、`home`、`custom` 组件，使用 `diff -rq` 或 `cmp` 比较备份源和恢复后的目标路径中的文件内容（对 `etc` 和 `custom` 会抽样比较关键文件或使用 `diff`，对 `home` 会抽样比较关键配置文件）。差异会记录在恢复日志旁的 `.diff` 文件中。
    *   **软件包验证**：检查备份列表 (`manually-installed.txt`) 中的软件包是否都已通过 `pacman -Q` 查询到。
    *   报告验证结果和发现的任何不一致项。
7.  **日志记录**：将详细的操作步骤、警告和错误信息记录到位于备份根目录下的 `restore_YYYY-MM-DD_HH-MM-SS.log` 文件中。
8.  **依赖检查**：在脚本开始时检查 `rsync`, `tar`, `gzip`, `bzip2`, `xz`, `diff`, `cmp`, `pacman` 等必要命令是否存在。
9.  **权限检查**：提示用户使用 `sudo` 运行脚本以获得完全的恢复权限，尤其是在恢复系统配置 (`/etc`) 或自定义路径时。
10. **临时文件清理**：自动清理解压压缩备份时产生的临时目录。

## 使用方法

1.  **确保备份存在**：使用 `arch-backup.sh` 或类似脚本创建至少一个备份。
2.  **配置文件**：确保 `$HOME/.config/arch-backup.conf` 文件存在且配置正确，特别是 `BACKUP_ROOT` 指向正确的备份位置。如果文件不存在，脚本会警告并使用默认值，但这通常不是期望的行为。
3.  **运行脚本**：
    ```bash
    sudo bash arch-restore.sh
    ```
    强烈建议使用 `sudo` 运行，因为恢复 `/etc` 和某些自定义路径需要 root 权限，并且恢复软件包列表也需要。
4.  **交互式选择**：
    *   脚本会列出找到的备份源，根据提示输入编号选择。
    *   脚本会列出选定备份中可恢复的组件，根据提示输入一个或多个编号（用空格分隔）或选择“全部恢复”。
    *   如果配置了恢复前备份，脚本会询问是否执行。
    *   脚本会要求最终确认恢复操作。
    *   恢复完成后，脚本会询问是否执行验证。
5.  **查看日志**：检查脚本输出和生成的日志文件 (`restore_*.log` 和可能的 `restore_*.log.diff`) 以了解恢复详情和任何潜在问题。

## 依赖项

运行此脚本需要安装以下软件包：

*   `rsync`：用于文件同步恢复。
*   `tar`, `gzip`, `bzip2`, `xz`：用于处理可能存在的压缩备份文件。
*   `diffutils` (提供 `diff` 和 `cmp`)：用于恢复后验证文件内容。
*   `pacman`：用于恢复软件包列表（如果选择恢复此组件）。

可以使用以下命令安装所有依赖：

```bash
sudo pacman -S rsync tar gzip bzip2 xz diffutils pacman
```

## 注意事项

*   **风险警告**：恢复操作具有风险，可能会覆盖现有数据。请务必理解脚本的操作，并在执行前确认备份源和恢复选项正确无误。**强烈建议在执行恢复前手动备份任何关键数据！**
*   **测试环境**：如果可能，请先在测试环境或虚拟机中测试恢复流程。
*   **家目录恢复**：恢复整个家目录可能会覆盖您在上次备份后所做的所有更改。请谨慎使用。如果只想恢复特定文件，可以考虑手动从备份目录复制。
*   **软件包恢复**：脚本使用 `pacman -S --needed` 安装备份列表中的软件包。这不会卸载当前系统上存在但备份列表中没有的软件包。它也不会处理 AUR 包或手动编译安装的包（除非它们被包含在自定义路径备份中）。
*   **系统状态**：恢复操作可能会改变系统状态。确保在稳定的系统环境下运行此脚本。
*   **错误处理**：脚本包含基本的错误处理，但可能无法覆盖所有异常情况。如果遇到问题，请仔细检查日志文件。

## 未来可能的改进

*   更精细的恢复前备份策略（例如使用 `rsync --backup-dir`）。
*   支持恢复特定文件或子目录的选择。
*   集成 AUR 助手 (如 `yay`, `paru`) 来恢复 AUR 软件包。
*   更详细的恢复后验证报告。
*   添加恢复系统服务状态（启用/禁用）的功能。
